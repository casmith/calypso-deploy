name: Deploy with Ansible

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Ansible Playbook
    runs-on: self-hosted
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          using: node20
      - name: Run Ansible Playbook
        run: |
          # Pass the secret inline via --extra-vars (simpler). GitHub masks secrets in logs.
          ansible-playbook -i hosts.yaml playbook.yaml \
            --extra-vars "compose_env.SERVER_PASS=${{ secrets.VALHEIM_PASS }}"

          # Alternative: set the secret as an environment variable and let the playbook read it.
          # Uncomment the lines below if you prefer this flow (playbook already supports VALHEIM_PASS lookup):
          # export VALHEIM_PASS="${{ secrets.VALHEIM_PASS }}"
          # ansible-playbook -i hosts.yaml playbook.yaml -e "target=calypso"
        shell: bash
