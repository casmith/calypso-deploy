- name: Deploy services with docker-compose
  hosts: "{{ target | default('servers') }}"
  gather_facts: false
  vars:
    # If a host defines `compose_src`, it will be used; otherwise fallback to `docker-compose.yaml`
  tasks:
    - name: Ensure deploy path exists
      ansible.builtin.file:
        path: "{{ deploy_path | default('/home/' ~ ansible_user) }}"
        state: directory

    - name: Populate compose_env from environment if not set
      set_fact:
        compose_env: "{{ compose_env | default({}) | combine({'SERVER_PASS': lookup('env','VALHEIM_PASS'), 'PIHOLE_API_PASS': lookup('env','PIHOLE_API_PASS')}) }}"
      when: compose_env is not defined or compose_env.SERVER_PASS is not defined

    - name: Create `.env` file from `compose_env` dict (if defined)
      ansible.builtin.copy:
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/.env"
        content: |
          {% for key, val in compose_env.items() -%}
          {{ key }}={{ val }}
          {% endfor -%}
        mode: '0600'
      when: compose_env is defined

    - name: Copy host-specific docker-compose to deploy path
      copy:
        src: "{{ compose_src | default('docker-compose.' ~ inventory_hostname ~ '.yaml') }}"
        dest: "{{ (deploy_path | default('/home/' ~ ansible_user)) }}/docker-compose.yaml"

    - name: Show which compose file was deployed
      debug:
        msg: "Deployed compose from '{{ compose_src | default('docker-compose.' ~ inventory_hostname ~ '.yaml') }}' to '{{ deploy_path | default('/home/' ~ ansible_user) }}/docker-compose.yaml'"

    - name: Create and start services
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_path | default('/home/' ~ ansible_user) }}"
      register: output
